<!DOCTYPE html>
<html>
<head>
    <title>WebGL Fix Test</title>
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.8.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.8.0/mapbox-gl.css" rel="stylesheet" />
    <style>
        body { margin: 20px; font-family: Arial, sans-serif; }
        .status { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #e8f5e8; color: #2e7d32; }
        .error { background: #ffebee; color: #c62828; }
        #map { width: 100%; height: 400px; border: 2px solid red; background: yellow; }
        .canvas-test { width: 200px; height: 100px; border: 1px solid black; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>WebGL Fix Test</h1>
    
    <div class="status">
        <p><strong>WebGL Support:</strong> <span id="webgl-status">Testing...</span></p>
        <p><strong>Canvas Test:</strong> <span id="canvas-status">Testing...</span></p>
        <p><strong>Map Status:</strong> <span id="map-status">Testing...</span></p>
    </div>
    
    <div class="canvas-test" id="canvas-test">Canvas test will appear here</div>
    
    <div id="map">Map will appear here...</div>

    <script>
        console.log('üîç Starting WebGL fix test...');
        
        // Test WebGL support
        function testWebGL() {
            const canvas = document.createElement('canvas');
            const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
            
            if (gl) {
                document.getElementById('webgl-status').textContent = '‚úÖ WebGL Supported';
                document.getElementById('webgl-status').className = 'status success';
                console.log('‚úÖ WebGL is supported');
                
                // Get renderer info
                const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                if (debugInfo) {
                    const renderer = gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL);
                    console.log('üéÆ WebGL Renderer:', renderer);
                }
                
                return true;
            } else {
                document.getElementById('webgl-status').textContent = '‚ùå WebGL Not Supported';
                document.getElementById('webgl-status').className = 'status error';
                console.log('‚ùå WebGL is not supported');
                return false;
            }
        }
        
        // Test basic canvas drawing
        function testCanvas() {
            const canvas = document.createElement('canvas');
            canvas.width = 200;
            canvas.height = 100;
            const ctx = canvas.getContext('2d');
            
            if (ctx) {
                ctx.fillStyle = 'blue';
                ctx.fillRect(10, 10, 50, 30);
                ctx.fillStyle = 'red';
                ctx.fillRect(70, 10, 50, 30);
                ctx.fillStyle = 'green';
                ctx.fillRect(130, 10, 50, 30);
                
                document.getElementById('canvas-test').appendChild(canvas);
                document.getElementById('canvas-status').textContent = '‚úÖ Canvas Working';
                document.getElementById('canvas-status').className = 'status success';
                console.log('‚úÖ Canvas drawing working');
                return true;
            } else {
                document.getElementById('canvas-status').textContent = '‚ùå Canvas Failed';
                document.getElementById('canvas-status').className = 'status error';
                console.log('‚ùå Canvas drawing failed');
                return false;
            }
        }
        
        // Run tests
        const webglSupported = testWebGL();
        const canvasWorking = testCanvas();
        
        if (!webglSupported) {
            document.getElementById('map-status').textContent = '‚ùå Cannot create map - WebGL required';
            document.getElementById('map-status').className = 'status error';
            return;
        }
        
        // Try to create map with various fixes
        try {
            mapboxgl.accessToken = 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw';
            
            const map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v12',
                center: [-73.5143, 40.7259],
                zoom: 10,
                antialias: false, // Disable antialiasing
                preserveDrawingBuffer: true, // Preserve drawing buffer
                failIfMajorPerformanceCaveat: false, // Don't fail on performance issues
                attributionControl: false // Disable attribution to reduce complexity
            });
            
            console.log('‚úÖ Map instance created with fixes');
            
            map.on('load', function() {
                console.log('‚úÖ Map loaded successfully');
                document.getElementById('map-status').textContent = '‚úÖ Map Loaded';
                document.getElementById('map-status').className = 'status success';
                document.getElementById('map').style.background = 'lightgreen';
                
                // Add a marker to test rendering
                new mapboxgl.Marker({ color: 'red' })
                    .setLngLat([-73.5143, 40.7259])
                    .addTo(map);
                
                console.log('‚úÖ Marker added');
            });
            
            map.on('error', function(e) {
                console.error('‚ùå Map error:', e);
                document.getElementById('map-status').textContent = '‚ùå Map Error: ' + (e.error ? e.error.message : 'Unknown');
                document.getElementById('map-status').className = 'status error';
                document.getElementById('map').style.background = 'lightcoral';
            });
            
            map.on('style.load', function() {
                console.log('‚úÖ Map style loaded');
            });
            
            map.on('sourcedata', function(e) {
                if (e.isSourceLoaded) {
                    console.log('‚úÖ Source loaded:', e.sourceId);
                }
            });
            
            // Force a repaint after a delay
            setTimeout(function() {
                if (map.isStyleLoaded()) {
                    console.log('‚úÖ Style is loaded, forcing repaint');
                    map.triggerRepaint();
                }
            }, 2000);
            
        } catch (error) {
            console.error('‚ùå Map creation error:', error);
            document.getElementById('map-status').textContent = '‚ùå Creation Error: ' + error.message;
            document.getElementById('map-status').className = 'status error';
        }
        
    </script>
</body>
</html>


